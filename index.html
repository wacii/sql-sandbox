<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdn.rawgit.com/kripken/sql.js/master/js/sql.js"></script>
  <style media="screen">
    #setup, #log, #input {
      width: 50vw;
    }
    #setup {
      height: 100px;
    }
  </style>
</head>
<body>
  <textarea id="setup">
    CREATE TABLE test (a int, b char);
    INSERT INTO test VALUES (1,"a"), (2,"b");
  </textarea>
  <ul id="log"></ul>
  <input id="input" type="text" name="code">
  <button id="reset">reset</button>
</body>
<script type="text/javascript">
  // constants
  var ENTER = 13;
  var UP = 38;
  var DOWN = 40;
  var push = Array.prototype.push;
  var slice = Array.prototype.slice;
  function noop() {};

  var commandTemplate = tag('li', { class: 'command' });
  var errorTemplate = tag('li', { class: 'error' });
  var promptTemplate = tag('li', { class: 'prompt' });

  // textarea containing sql commands run when db is initialized
  var setup = $('#setup')
  // list of previously run sql commands and their results/errors
  var log = $('#log');
  // input user enters in sql commands to be run
  var input = $('#input');
  // clears log, input, and restores the db with setup code
  var reset = $('#reset');

  var lessons = [];
  lessons.push({
    title: 'Intro',
    steps: [
      prompt('Welcome to the first sql lesson!.'),
      prompt('You are going to learn how to interact with an existing db.'),
      prompt('But first lets create a table.'),
      pressEnter(),
      prompt('First we create a table.'),
      prompt('It will be named products and will have id and name columns.'),
      command('CREATE TABLE products (id int, name char);'),
      pressEnter(),
      prompt('Now lets add some data to our products table'),
      command('INSERT INTO products VALUES (1, "radio"), (2, "tv");'),
      pressEnter(),
      prompt('You might not understand the previous commands, but that is ok.'),
      prompt('Well get to those commands later.'),
      prompt('Lets start pulling data from our table!'),
      pressEnter(),
      prompt('Lets see how to pull all the ids from products'),
      command('SELECT id FROM products;'),
      pressEnter(),
      prompt('Now you try and select all the names from products'),
      lessonComplete()
    ]
  });

  var currentLesson = lessons[0];
  var stepPointer = 0;
  var waitingForEnter = false;
  var lessonComplete = false

  var lessonActions = {
    prompt: function(step) {
      logPrompt(step.text);
      stepPointer++;
      processLesson();
    },
    command: function(step) {
      executeLessonCommand(step.text);
      stepPointer++;
      processLesson();
    },
    pressEnter: function(step) {
      logPrompt('Press enter to continue.');
      waitingForEnter = true;
    },
    lessonComplete: function(step) {
      if (!lessonComplete) logPrompt('Lesson complete!');
      lessonComplete = true;
    }
  }

  function processLesson() {
    var step = currentLesson.steps[stepPointer];
    waitingForEnter = false;
    lessonActions[step.type](step);
  }

  // TODO: can this be improved...feels off
  function enterPressed() {
    if (waitingForEnter) {
      stepPointer++;
      processLesson();
    }
  }

  function prompt(str) { return { type: 'prompt', text: str } }
  function command(str) { return { type: 'command', text: str } }
  function pressEnter() { return { type: 'pressEnter' } }
  function lessonComplete() { return { type: 'lessonComplete' } }

  // remember user commands so they can be browsed with up and down arrow
  function CommandHistory(el) {
    this.input = el;
    this.pointer = 0;
  }

  CommandHistory.prototype.push = function(value) {
    push.call(this, value);
    this.pointer = this.length - 1;
  };

  CommandHistory.prototype.back = function() {
    if (this.pointer > 0) this.pointer--;
    this.input.val(this[this.pointer]);
  };

  CommandHistory.prototype.forward = function() {
    if (this.pointer < this.length) this.pointer++;
    this.input.val(this[this.pointer]);
  };

  CommandHistory.prototype.clear = function() {
    slice.call(this, 0, this.length);
    this.pointer = 0;
  }

  var commandHistory = new CommandHistory(input);

  var db;
  resetDb();

  processLesson();

  input.on('keyup', function(event) {
    if (event.which === ENTER) executeUserCommand(input.val());
    else if (event.which === UP) commandHistory.back();
    else if (event.which === DOWN) commandHistory.forward();
  });

  reset.on('click', function(event) {
    clearInput();
    clearLog();
    commandHistory.clear();
    resetDb();
  })

  // TODO: consider making a db object
  function resetDb() {
    if (db != null && db.close != null) db.close();
    db = new SQL.Database();
    executeCommand(noop, logError)(setup.val());
    logError(executeCommand(setup.val()));
  }

  function executeCommand(command) {
    if (command.str === '') return command;
    try {
      var statement = db.prepare(command.str);
      if (statement.step())
        command.results = db.exec(command.str)[0];
    } catch(error) {
      command.error = error;
    } finally {
      return command;
    }
  }

  function rememberCommand(command) {
    commandHistory.push(command.str);
    return command;
  }

  function logError(command) {
    if (command.error != null)
      addToLog(errorTemplate(command.error));
    return command;
  }

  function logResults(command) {
    if (command.results != null)
      addToLog(resultsTemplate(command.results));
    return command;
  }

  function logCommand(command) {
    addToLog(commandTemplate(command.str));
    return command;
  }

  function logPrompt(prompt) {
    addToLog(promptTemplate(prompt));
  }

  function addToLog(html) {
    log.append(html);
  }

  function clearInput() {
    input.val('');
  }

  function clearLog() {
    log.empty();
  }

  function executeUserCommand(str) {
    var command = { str: str };
    logError(logResults(logCommand(rememberCommand(executeCommand(command)))));
    // TODO: improve upon this...consider validations
    enterPressed();
    clearInput();
  }

  function executeLessonCommand(str) {
    var command = { str: str };
    logError(logResults(logCommand(executeCommand(command))));
  }

  // helper method for templates
  function tag(tagName, attributes) {
    return function(content) {
      var attrStr = ''
      if (typeof attributes === 'object') {
        var keys = Object.keys(attributes);
        attrStr = keys.map(function(key) {
          return key + '=' + attributes[key];
        }).join(' ');
      }
      return '<' + tagName + ' ' + attrStr + '>' +
        content + '</' + tagName + '>';
    }
  }

  function resultsTemplate(results) {
    var headers = tag('tr')(results.columns.map(tag('th')).join(''));
    var rows = results.values.map(function(record) {
      return tag('tr')(record.map(tag('td')).join(''));
    });
    return tag('li')(tag('table')(headers + rows.join('')));
  }
</script>
</html>
