<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdn.rawgit.com/kripken/sql.js/master/js/sql.js"></script>
  <style media="screen">
    #setup, #log, #input {
      width: 50vw;
    }
    #setup {
      height: 100px;
    }
  </style>
</head>
<body>
  <textarea id="setup">
    CREATE TABLE test (a int, b char);
    INSERT INTO test VALUES (1,"a"), (2,"b");
  </textarea>
  <ul id="log"></ul>
  <input id="input" type="text" name="code">
  <button id="reset">reset</button>
</body>
<script type="text/javascript">
  // constants
  var ENTER = 13;
  var UP = 38;
  var DOWN = 40;
  var push = Array.prototype.push;
  var slice = Array.prototype.slice;
  var splice = Array.prototype.splice;
  function noop() {}

  var commandTemplate = tag('li', { class: 'command' });
  var errorTemplate = tag('li', { class: 'error' });
  var promptTemplate = tag('li', { class: 'prompt' });

  // textarea containing sql commands run when db is initialized
  var setup = $('#setup')
  // list of previously run sql commands and their results/errors
  var log = $('#log');
  // input user enters in sql commands to be run
  var input = $('#input');
  // clears log, input, and restores the db with setup code
  var reset = $('#reset');

  function clearInput() {
    input.val('');
  }
  function clearLog() {
    log.empty();
  }

  var lessons = [];
  lessons.push({
    title: 'Intro',
    steps: [
      prompt('Welcome to the first sql lesson!.'),
      prompt('You are going to learn how to interact with an existing db.'),
      prompt('But first lets create a table.'),
      pressEnter(),
      prompt('First we create a table.'),
      prompt('It will be named products and will have id and name columns.'),
      command('CREATE TABLE products (id int, name char);'),
      pressEnter(),
      prompt('Now lets add some data to our products table'),
      command('INSERT INTO products VALUES (1, "radio"), (2, "tv");'),
      pressEnter(),
      prompt('You might not understand the previous commands, but that is ok.'),
      prompt('Well get to those commands later.'),
      prompt('Lets start pulling data from our table!'),
      pressEnter(),
      prompt('Lets see how to pull all the ids from products'),
      command('SELECT id FROM products;'),
      pressEnter(),
      prompt('Now you try and select all the names from products'),
      checkResults([{ type: 'columns', columns: ['name'] }]),
      prompt('Dont select the product with id 1'),
      checkResults([{ type: 'excludes', values: [[1, "radio"]] }]),
      prompt('Select all columns of product with id 1'),
      checkResults([{ type: 'includes', values: [[1, "radio"]] }]),
      prompt('Select all products'),
      checkResults([{ type: 'count', count: 2 }]),
      lessonComplete()
    ]
  });

  var currentLesson = lessons[0];
  var stepPointer = 0;

  function currentStep() {
    return currentLesson.steps[stepPointer]
  }

  // TODO: bundle `stepPointer++; processLesson();`
  var lessonActions = {
    prompt: function(step) {
      logPrompt(step.text);
      stepPointer++;
      processLesson();
    },
    command: function(step) {
      executeLessonCommand(step.text);
      stepPointer++;
      processLesson();
    },
    pressEnter: function(step) {
      logPrompt('Press enter to continue.');
    },
    lessonComplete: function(step) {
      logPrompt('Lesson complete!');
    },
    checkResults: noop,
    checkForChanges: noop
  }

  function processLesson() {
    var step = currentStep();
    lessonActions[step.type](step);
  }

  function enterPressed(command) {
    if (currentStep().type !== 'pressEnter') return command;

    stepPointer++;
    processLesson();
    return command;
  }

  function resultsExpectation(command) {
    var step = currentStep();
    if (step.type !== 'checkResults') return command;

    if (compareResults(command.results, step.expectations)) {
      logPrompt('Success!');
      stepPointer++;
      processLesson();
    }
    return command;
  }

  function forChangesExpectation(command) {
    var step = currentStep();
    if (step.type !== 'checkForChanges') return command;

    results = pipe(step.commandStr, prepareCommand, executeCommand).results
    if (compareResults(results, step.expectations)) {
      logPrompt('Success!');
      processLesson();
    }
    return command;
  }

  checkExpectation = {
    columns: function(results, expectation) {
      if (results.columns.length !== expectation.columns.length) return false;
      return arrayContains(results.columns, expectation.columns);
    },
    includes: function(results, expectation) {
      var result = results.values;
      var expected = expectation.values;

      var len = expected.length;
      for (var i = 0; i < len; i++)
        if (!arrayDeepContains(result, expected[i])) return false;
      return true;
    },
    excludes: function(results, expectation) {
      var result = results.values;
      var expected = expectation.values;

      var len = expected.length;
      for (var i = 0; i < len; i++)
        if (!arrayDeepHasNone(result, expected[i])) return false;
      return true;
    },
    count: function(results, expectation) {
      return results != null && results.values.length === expectation.count;
    }
  }

  function compareResults(results, expectations) {
    var len = expectations.length;
    for (var i = 0; i < len; i++) {
      var expectation = expectations[i];
      if(!checkExpectation[expectation.type](results, expectation))
        return false;
    }
    return true;
  }

  function arrayDeepContains(arrays, arr) {
    var len = arrays.length;
    for (var i = 0; i < len; i++)
      if (!arrayContains(arrays[i], arr)) return false;
    return true;
  }

  function arrayDeepHasNone(arrays, arr) {
    var len = arrays.length;
    for (var i = 0; i < len; i++)
      if (!arrayHasNone(arrays[i], arr)) return false;
    return true;
  }

  function arrayContains(arr1, arr2) {
    var len = arr2.length;
    for (var i = 0; i < len; i++)
      if (arr1.indexOf(arr2[i]) === -1) return false;
    return true;
  }

  function arrayHasNone(arr1, arr2) {
    var len = arr2.length;
    for (var i = 0; i < len; i++)
      if (arr1.indexOf(arr2[i]) !== -1) return false;
    return true;
  }

  function prompt(str) { return { type: 'prompt', text: str } }
  function command(str) { return { type: 'command', text: str } }
  function pressEnter() { return { type: 'pressEnter' } }
  function lessonComplete() { return { type: 'lessonComplete' } }

  function checkResults(arr) {
    return { type: 'checkResults', expectations: arr };
  }

  function checkForChanges(str, arr) {
    return { type: 'checkForChanges', expectations: arr, commandStr: str };
  }

  // remember user commands so they can be browsed with up and down arrow
  function CommandHistory(el) {
    this.input = el;
    this.pointer = 0;
  }

  CommandHistory.prototype.push = function(value) {
    push.call(this, value);
    this.pointer = this.length - 1;
  };

  CommandHistory.prototype.back = function() {
    if (this.pointer > 0) this.pointer--;
    this.input.val(this[this.pointer]);
  };

  CommandHistory.prototype.forward = function() {
    if (this.pointer < this.length) this.pointer++;
    this.input.val(this[this.pointer]);
  };

  CommandHistory.prototype.clear = function() {
    splice.call(this, 0, this.length);
    this.pointer = 0;
  }

  // TODO: define as singleton when you move to browserify
  var commandHistory = new CommandHistory(input);

  var db;
  resetDb();

  processLesson();

  input.on('keyup', function(event) {
    if (event.which === ENTER) executeUserCommand(input.val());
    else if (event.which === UP) commandHistory.back();
    else if (event.which === DOWN) commandHistory.forward();
  });

  reset.on('click', function(event) {
    clearInput();
    clearLog();
    commandHistory.clear();
    resetDb();
  })

  // TODO: consider making a db object
  function resetDb() {
    if (db != null && db.close != null) db.close();
    db = new SQL.Database();
    pipe(setup.val(), prepareCommand, executeCommand, logError);
  }

  function prepareCommand(str) {
    if (str == null) str = '';
    return { str: str };
  }

  function executeCommand(command) {
    if (command.str === '') return command;
    try {
      var statement = db.prepare(command.str);
      if (statement.step())
        command.results = db.exec(command.str)[0];
    } catch(error) {
      command.error = error;
    } finally {
      return command;
    }
  }

  function rememberCommand(command) {
    // TODO: extract assumed stated
    commandHistory.push(command.str);
    return command;
  }

  function logError(command) {
    if (command.error != null)
      addToLog(errorTemplate(command.error));
    return command;
  }

  function logResults(command) {
    if (command.results != null)
      addToLog(resultsTemplate(command.results));
    return command;
  }

  function logCommand(command) {
    addToLog(commandTemplate(command.str));
    return command;
  }

  function logPrompt(prompt) {
    addToLog(promptTemplate(prompt));
  }

  function addToLog(html) {
    log.append(html);
  }

  function pipe(value) {
    var fns = slice.call(arguments, 1, arguments.length);
    var fn;
    while (fn = fns.shift())
      value = fn(value);
    return value;
  }

  function executeUserCommand(str) {
    pipe(str, prepareCommand,
      executeCommand, rememberCommand, logCommand, logResults, logError,
      enterPressed, resultsExpectation, forChangesExpectation);
    clearInput();
  }

  function executeLessonCommand(str) {
    pipe(str, prepareCommand, executeCommand, logCommand, logResults, logError);
  }

  // helper method for templates
  function tag(tagName, attributes) {
    return function(content) {
      var attrStr = ''
      if (typeof attributes === 'object') {
        var keys = Object.keys(attributes);
        attrStr = keys.map(function(key) {
          return key + '=' + attributes[key];
        }).join(' ');
      }
      return '<' + tagName + ' ' + attrStr + '>' +
        content + '</' + tagName + '>';
    }
  }

  function resultsTemplate(results) {
    var headers = tag('tr')(results.columns.map(tag('th')).join(''));
    var rows = results.values.map(function(record) {
      return tag('tr')(record.map(tag('td')).join(''));
    });
    return tag('li')(tag('table')(headers + rows.join('')));
  }
</script>
</html>
